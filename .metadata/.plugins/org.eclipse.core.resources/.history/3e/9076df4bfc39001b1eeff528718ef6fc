<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@page import="java.util.GregorianCalendar"%>
<%@page import="java.util.Calendar"%>
<%Calendar cal = new GregorianCalendar();
String year= cal.get(GregorianCalendar.YEAR)+"";
String month=cal.get(GregorianCalendar.MONTH)+1+"";
String day = cal.get(GregorianCalendar.DAY_OF_MONTH)+"";
%>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.1/handlebars.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>[비용 입력]</title>
</head>
<body>
	<h1>[비용 입력]</h1>
	<form id="frm" action="costinsert" method="post">
		<div id="predate" style="float:left;">◀</div>
		<div id="date" style="float:left;"></div>
		<div id="Nextdate">▶</div>
		<div style="float:left; margin-right:50px;">
			<table id="tbl" border=1 style="border-collapse:collapse;"></table>
		</div>
		<div>
			<table id="tbl1" border=1 style="border-collapse:collapse;">
				<tr>
					<td>합계금액</td>
					<td></td>
				<tr>
				<tr>
					<td width=200>계정명</td>
					<td width=200>발생금액</td>
				</tr>
				<tbody id= "body"></tbody>
			</table>
		</div>
		<input type="submit" value="저장">
		<input type="reset" value="취소">
	</form>
</body>
	<script>
	date();
	//날짜 출력
	function date(){
		var year=<%=year%>
		var month=<%=month%>
		var strday=<%=day%>
		if(strday<10){
			var day="0"+strday;
			var date=year+"/"+month+"/"+day;
			$("#date").html(date);
		}
	}
		getlist();
		//비용리스트 불러오기
		function getlist(){
			var str="<tr><td width=150>비용계정명</td></tr>";
			$.ajax({
				type : "get",
				url : "costaccount.json",
				dataType : "json",
				success : function(data){
					if($(data.COSTACCOUNTNAME)!= null){
						$(data).each(function(){
							str +="<tr class='row'>";
							str +="<td width=150 class='costname' name='"+this.COSTACCOUNTNAME+"' code='"+this.COSTACCOUNTCODE+"'>"+this.COSTACCOUNTNAME+"</td>";
							str +="</tr>";
						});
						$("#tbl").html(str);
					}
				}
			});
		}

		//체크박스 전체선택
		$("#tbl").on("click", "#chkAll", function(){
			if($(this).is(":checked")){
				$("#tbl .row .chk").each(function(){
					$(this).prop("checked",true);
					
				});
			} else {
				$("#tbl .row .chk").each(function(){
					$(this).prop("checked",false);
				});
			}
		});
		//개별전체선택시
		 $("#tbl").on("click", ".row .chk", function(){
		        var isCheck=true;
		        $("#tbl .row .chk").each(function(){
		        	if(!$(this).is(":checked")) isCheck=false
		        });
		        if(isCheck){
		            $("#chkAll").prop("checked", true);
		        }else{
		            $("#chkAll").prop("checked", false);
		        }
		        
		    });
		//비용 계정 추가시
		$("#tbl").on("click",".costname",function(){
			var costname=$(this).attr("name");
			var costcode=$(this).attr("code");
			var str="<tr class='costrow'><td costcode='"+costcode+"'>"+costname+"</td><td><input type='text' class='cost'>원</td></tr>";
			$("#tbl1 > tbody:last").append(str);
			$("[name="+costname+"]").hide();
		});
		
		//저장시
		$(frm).submit(function(){
			var companycode = "153-60-00064";
 			var day = $("#date").html().substring(2);
 			$("#tbl1 #body .costrow").each(function(){
				var code = $(this).attr("costcode");
				var amount= $(this).find(".cost").val();
				alert(code);
				$.ajax({
					type : "post",
					url : "costinsert",
					data : {"cost_companycode" : companycode ,"cost_day": day, "cost_costaccountcode" :code, "costamount":amount},
 					success : function(){
						
 					}
				});
			});
			alert("저장완료되었습니다.");
	});
	</script>
</html>